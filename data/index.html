<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Modbus TCP IO Module Configuration</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    <!-- Add Chart.js library -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="container">
        <div class="device-info-card">
            <div class="device-header">
                <h1>Modbus TCP IO Module</h1>
                <div class="device-info-header">
                    <div class="device-info-item">
                        <span class="device-type" id="device-type">Loading...</span>
                        <span class="firmware-version" id="firmware-version">Loading...</span>
                    </div>
                    <div class="status-item">
                        <span class="status-indicator" id="modbus-status"></span>
                        <span id="modbus-status-text">Loading...</span>
                    </div>
                </div>
            </div>
            
            <div class="device-details">
                <div class="device-detail-column">
                    <div class="device-detail">
                        <div class="device-detail-label">IP Address</div>
                        <div class="device-detail-value" id="current-ip">Loading...</div>
                    </div>
                    <div class="device-detail">
                        <div class="device-detail-label">Hostname</div>
                        <div class="device-detail-value" id="current-hostname">Loading...</div>
                    </div>
                </div>
                <div class="device-detail-column">
                    <div class="device-detail">
                        <div class="device-detail-label">Modbus Port</div>
                        <div class="device-detail-value" id="current-modbus-port">Loading...</div>
                    </div>
                    <div class="device-detail">
                        <div class="device-detail-label">Connected Clients</div>
                        <div class="device-detail-value" id="client-count">0</div>
                    </div>
                    <div class="device-detail">
                        <div class="device-detail-label">Sensor Simulation</div>
                        <div class="device-detail-value">
                            <label class="switch">
                                <input type="checkbox" id="global-simulation-toggle">
                                <span class="slider"></span>
                            </label>
                            <span class="switch-label" id="simulation-status-text">OFF</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="client-section" id="client-section" style="display: none;">
                <h2>Connected Clients</h2>
                <div class="client-grid" id="client-list">
                    <div class="no-clients">No clients connected</div>
                </div>
            </div>
        </div>
        
        <div class="card">
            <h1>Network Configuration</h1>
            
            <div class="switch-wrapper">
                <label class="switch">
                    <input type="checkbox" id="dhcp">
                    <span class="slider"></span>
                </label>
                <span class="switch-label">Enable DHCP</span>
            </div>
            
            <div class="form-group">
                <label for="hostname">Hostname</label>
                <input type="text" id="hostname">
            </div>
            
            <div class="form-group">
                <label for="ip">IP Address</label>
                <input type="text" id="ip">
            </div>
            
            <div class="form-group">
                <label for="subnet">Subnet Mask</label>
                <input type="text" id="subnet">
            </div>
            
            <div class="form-group">
                <label for="gateway">Gateway</label>
                <input type="text" id="gateway">
            </div>
            
            <div class="form-group">
                <label for="modbus_port">Modbus Port</label>
                <input type="number" id="modbus_port" min="1" max="65535">
            </div>
            
            <button onclick="saveConfig()">Save Configuration</button>
            <div id="status" class="status"></div>
        </div>

        <div class="card" id="io-status-card">
            <h1>IO Status</h1>
            <div class="io-section">
                <div class="io-group">
                    <h3 class="with-button">Digital Inputs
                        <button id="reset-latches-btn" class="action-button small-button">Reset Latches</button>
                    </h3>
                    <div id="digital-inputs" class="io-grid"></div>
                    <p class="info-text"><span class="info-icon">ℹ️</span> Latched inputs will remain ON even if the physical input returns to OFF state. Click on a latched input to reset it, or use the Reset Latches button to reset all. Latches can be reset via Modbus by writing '1' to coils 100-107 (FC 5).</p>
                </div>
                
                <div class="io-group">
                    <h3>Digital Outputs</h3>
                    <div id="digital-outputs" class="io-grid"></div>
                    <p class="info-text"><span class="info-icon">ℹ️</span> Inverted outputs are shown as set by the modbus master, ie. coil on is shown as output ON. An inverted output pin will be at 0V when ON and 3.3V when OFF.</p>
                </div>
                
                <div class="io-group">
                    <h3>Analog Inputs</h3>
                    <div id="analog-inputs" class="io-grid"></div>
                    <div class="charts-container">
                        <div class="chart-wrapper">
                            <h4>Analog Input Trends</h4>
                            <div class="chart-area">
                                <canvas id="analog-chart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="io-group">
                    <h3>I2C Sensors</h3>
                    <div id="i2c-sensors-container" class="io-grid"></div>
                </div>
            </div>
        </div>
        
        <div class="card config-card">
            <div class="card-header">
                <h2>IO Configuration</h2>
            </div>
            <div class="card-body">
                <p class="info-text"><span class="info-icon">ℹ️</span> Latched inputs remain ON until manually reset or read via Modbus. For Modbus clients, latches can be reset by writing '1' to coils 100-107.</p>
                <div id="di-config"></div>
                <div id="do-config"></div>
                <div class="button-container">
                    <button onclick="saveIOConfig()">Save IO Configuration</button>
                    <div class="logo-container">
                        <a href="https://peakeinnovation.com" target="_blank">
                            <img src="logo.png" alt="Peake Electronic Innovation Logo" class="logo">
                        </a>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="card config-card">
            <div class="card-header">
                <h2>Sensor Configuration</h2>
            </div>
            <div class="card-body">
                <!-- Modbus Register Usage Map -->
                <div class="register-usage-summary">
                    <h3>Modbus Register Usage Map</h3>
                    <div class="register-sections">
                        <!-- Discrete Inputs -->
                        <div class="register-section">
                            <h4>Discrete Inputs (FC2)</h4>
                            <div id="discrete-inputs-map" class="register-grid">
                                <!-- Will be populated by JavaScript -->
                            </div>
                        </div>
                        
                        <!-- Coils -->
                        <div class="register-section">
                            <h4>Coils (FC1/FC5)</h4>
                            <div id="coils-map" class="register-grid">
                                <!-- Will be populated by JavaScript -->
                            </div>
                        </div>
                        
                        <!-- Input Registers -->
                        <div class="register-section">
                            <h4>Input Registers (FC4)</h4>
                            <div id="input-registers-map" class="register-grid">
                                <!-- Will be populated by JavaScript -->
                            </div>
                        </div>
                        
                        <!-- Holding Registers -->
                        <div class="register-section">
                            <h4>Holding Registers (FC3)</h4>
                            <div id="holding-registers-map" class="register-grid">
                                <!-- Will be populated by JavaScript -->
                            </div>
                        </div>
                    </div>
                    
                    <!-- Legend -->
                    <div class="register-legend">
                        <div class="legend-item">
                            <div class="legend-color" style="background: var(--success-color);"></div>
                            <span>System I/O</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: var(--warning-color);"></div>
                            <span>Enabled Sensors</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: #ffc107; opacity: 0.6; border: 1px dashed #adb5bd;"></div>
                            <span>Disabled Sensors</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: var(--primary-color);"></div>
                            <span>System Reserved</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: #e9ecef; border: 1px dashed #ced4da;"></div>
                            <span>Available</span>
                        </div>
                    </div>
                </div>
                
                <div class="sensor-config-controls">
                    <button onclick="showAddSensorModal()">Add Sensor</button>
                    <button onclick="saveSensorConfig()">Save & Reboot</button>
                </div>
                <div class="sensor-table-container">
                    <table class="sensor-table" id="sensor-table">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Type</th>
                                <th>I2C Address</th>
                                <th>Modbus Register</th>
                                <th>Enabled</th>
                                <th>Calibrated</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="sensor-table-body">
                            <tr class="no-sensors">
                                <td colspan="7">No sensors configured</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <div class="github-link-container">
        <div class="footer-info">
            <span class="version-info">Modbus TCP IO Module V1.0.1</span>
            <a href="https://github.com/PeakeElectronicInnovation/modbus-io-module" target="_blank" class="github-link">
                <svg class="github-icon" viewBox="0 0 16 16" width="16" height="16">
                    <path fill="currentColor" d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0 0 16 8c0-4.42-3.58-8-8-8z"/>
                </svg>
                View Documentation on GitHub
            </a>
        </div>
    </div>
    
    <!-- Toast container for notifications -->
    <div id="toast-container"></div>
    
    <!-- Sensor configuration modal -->
    <div class="modal-overlay" id="sensor-modal-overlay" onclick="hideSensorModal()">
        <div class="modal" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h3 id="sensor-modal-title">Add Sensor</h3>
                <button class="modal-close" onclick="hideSensorModal()">&times;</button>
            </div>
            <form class="modal-body" id="sensor-form">
                <div class="form-group">
                    <label for="sensor-name">Name</label>
                    <input type="text" id="sensor-name" maxlength="31" placeholder="e.g., Temperature Sensor" required>
                </div>
                <div class="form-group">
                    <label for="sensor-type">Type</label>
                    <select id="sensor-type" required>
                        <option value="">Select sensor type</option>
                        <option value="BME280">BME280 (Temperature, Humidity, Pressure)</option>
                        <option value="BMP280">BMP280 (Temperature, Pressure)</option>
                        <option value="SHT30">SHT30 (Temperature, Humidity)</option>
                        <option value="DS18B20">DS18B20 (Temperature)</option>
                        <option value="ADS1115">ADS1115 (4-Channel ADC)</option>
                        <option value="EZO_PH">EZO-pH (pH Sensor)</option>
                        <option value="EZO_EC">EZO-EC (Conductivity)</option>
                        <option value="EZO_DO">EZO-DO (Dissolved Oxygen)</option>
                        <option value="Custom">Custom</option>
                    </select>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="sensor-i2c-address">I2C Address (Hex)</label>
                        <input type="text" id="sensor-i2c-address" pattern="^(0x)?[0-9A-Fa-f]{1,2}$" placeholder="0x48" required>
                    </div>
                    <div class="form-group">
                        <label for="sensor-modbus-register">Modbus Register</label>
                        <input type="number" id="sensor-modbus-register" min="5" max="65535" placeholder="100" required>
                        <small class="form-help">Registers 0-4 reserved for system I/O. Use 5 or higher.</small>
                    </div>
                </div>
                <div class="form-group">
                    <label class="checkbox-label">
                        <input type="checkbox" id="sensor-enabled" checked>
                        <span class="checkbox-text">Enable sensor</span>
                    </label>
                </div>
                
                <div class="form-section">
                    <h4>Calibration Settings</h4>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="sensor-calibration-offset">Offset</label>
                            <input type="number" id="sensor-calibration-offset" step="0.01" value="0" placeholder="0.0">
                            <small class="form-help">Added to raw sensor reading</small>
                        </div>
                        <div class="form-group">
                            <label for="sensor-calibration-scale">Scale Factor</label>
                            <input type="number" id="sensor-calibration-scale" step="0.001" value="1" placeholder="1.0" min="0.001">
                            <small class="form-help">Raw reading multiplied by this factor</small>
                        </div>
                    </div>
                    <small class="form-help">Final value = (Raw × Scale) + Offset</small>
                </div>
            </form>
            <div class="modal-footer">
                <button type="button" onclick="hideSensorModal()">Cancel</button>
                <button type="button" onclick="saveSensor()">Save</button>
            </div>
        </div>
    </div>
    
    <!-- Calibration modal -->
    <div class="modal-overlay" id="calibration-modal-overlay" onclick="hideCalibrationModal()">
        <div class="modal" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h3 id="calibration-modal-title">Calibrate Sensor</h3>
                <button class="modal-close" onclick="hideCalibrationModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="calibration-info">
                    <div class="sensor-info">
                        <strong>Sensor:</strong> <span id="calibration-sensor-name"></span><br>
                        <strong>Type:</strong> <span id="calibration-sensor-type"></span>
                    </div>
                </div>
                
                <div class="form-section">
                    <h4>Calibration Parameters</h4>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="calibration-offset">Offset</label>
                            <input type="number" id="calibration-offset" step="0.01" value="0" placeholder="0.0">
                            <small class="form-help">Added to raw sensor reading</small>
                        </div>
                        <div class="form-group">
                            <label for="calibration-scale">Scale Factor</label>
                            <input type="number" id="calibration-scale" step="0.001" value="1" placeholder="1.0" min="0.001">
                            <small class="form-help">Raw reading multiplied by this factor</small>
                        </div>
                    </div>
                    <div class="calibration-formula">
                        <strong>Formula:</strong> Final Value = (Raw Reading × Scale Factor) + Offset
                    </div>
                </div>
                
                <div class="calibration-examples">
                    <h4>Common Calibrations</h4>
                    <div class="calibration-presets">
                        <button type="button" onclick="resetCalibration()" class="preset-btn">Reset to Default</button>
                        <button type="button" onclick="document.getElementById('calibration-offset').value = 2.0; document.getElementById('calibration-scale').value = 1.0;" class="preset-btn">+2°C Offset</button>
                        <button type="button" onclick="document.getElementById('calibration-offset').value = 0; document.getElementById('calibration-scale').value = 0.95;" class="preset-btn">5% Scale Down</button>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" onclick="hideCalibrationModal()">Cancel</button>
                <button type="button" onclick="saveCalibration()">Save Calibration</button>
            </div>
        </div>
    </div>
    
    <script src="script.js"></script>
</body>
</html>